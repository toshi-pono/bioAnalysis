const LINE_WIDTH = 2;
const PADDING = 100;
const PADDING_BOTTOM = 20;

// 描画桁数
const NUMBER_DIGIT = 2;

window.onload = () => {
  const canvas = document.getElementById("canvas");
  const elapsed = document.getElementById("elapsed");
  const context = canvas.getContext("2d");
  context.textAlign = "center";
  context.textBaseline = "top";

  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  const TREE_HEIGHT = HEIGHT - PADDING_BOTTOM;

  const aminos = [
    "MTQTPYEVIGAEALYDLIDNFYSLVAQDTRINHLFPTDLSETSRKQKQFLTQFLGGPNLYTQEHGHPMLKRRHLEFTITHFERDAWLENMHQAIANAQLPAGVGDYLYERLRLTANHMVNSEN",
    "MTPYEVINPQDLYDMIDHFYYLVEKDNRINHLFPGDFAETSRKQKQFLTQFLGGPSLYTEEHGHPMLRQRHLPFRITDKERDAWLENMREAITSSQLNEDVQEYLYERLKLTANHMVNA",
    "MAQTPYEIIGHDALYKMIDHFYFLVEKDDRINHLFPGDFQETSRKQKQFLTQFLGGPSLYSEEHGHPMLKRRHMEFIITNNERDAWLENMYSAIQHADFQAGVGDYLYERLRLTANHIVNTEN",
    "MTQTPYEVIGQDALFKMIDHFYYMVQRDDRINHLFPGDFEETSRKQKQFLTQFLGGPQLYTEEHGHPMLKKRHLEFVITTHERDAWLENMYKAIQQADFPAGVGDYLYERLRLTANHMVNSEN",
    "MKFGEVMAQTPYNIIGQEALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGPQLYTEEGHSMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MAPNPYEVIGKERLYSMIDYFYSLVEKDERINYLFPGDFAETSRKQKQFLTQFLGGPALYTEEHGHPMLKMRHMEFRITSFERDAWLENMNKAIQHAELPAGVDEYLYERLRMTAHHMVNSEN",
    "MTQTPYEVIGQDALFKMIDHFYYMVERDDRINHLFPGDFEETSRKQKQFLTQFLGGPQLYTEEHGHPMLKKRHLEFVITTDERDAWLENMYEAIQQAHFPAGVGDYLYERLRLTANHMVNSEN",
    "MTQTPYEIIGQDALFKMIDHFYYMVQRDDRINHLFPGDFEETSRKQKQFLTQFLGGPQLYTEEHGHPMLKKRHLEFVITTHERDAWLENMYKAIQQADFPAGVGDYLYERLRLTANHMVNSEN",
    "MTQTPYEIIGHDALYKMIDHFYYLVKRDDRINHLFPGDFEETSRKQKQFLTQFLGGPNLYTQEHGHPMLKKRHMDFIITNHGRDAWLENMAHAIAHAQFPAGVGDYLYERLRLTANHMVNSEN",
    "MTQTPYDVIGAQALYNLIDNFYSLVSQDIRLNHLFPEDLTETSRKQKQFLTQFLGGPSLYTEEHGHPMLKRRHLDFTITHLERDAWLENMQRAIIDVQLPAGVGDYLYERLRLTANHMVNSEN",
    "MKFGEVMAQTPYNIIGQEALYAMIDHFYRLVEQDDRINYLFLGDFKETSRKQKQFLTQFLGGPHLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MAQTPYEIIGHDALYKMIDHFYFLVEKDDRINHLFPGDFQKTSRKQKQFLTQFLGGPSLYSEEHGHPMLKRRHMEFIITNNERDAWLENMYSAIQHADFQAGVGDYLYERLRLTANHMVNTEN",
    "MAQTPYEIIGHDALYKMIDHFYFLVEKDDRINYLFPGDFQETSRKQKQFLTQFLGGPSLYTEEHGHPMLKRRHIEFIITNNERDAWLENMYSAIQHANFQAGVGDYLYERLRLTANHMVNTEN",
    "MTQTPYEVIGPEALYDLIDNFYSLVAQDTRINHLFPTDLSETSRKQKQFLTQFLGGPNLYTQEHGHPMLKRRHLEFTITHFERDAWLENMHQAITNAQLPAGVGDYLYERLRLTANHMVNSEN",
    "MEIGDIMSKTPYEVIGETALYNMIAHFYSLVEKDDRINHLFPGDFAETSRKQKQFLTQFLGGLNLYTQEHGHPILKKRHMEFKITPYERDAWLENMHIAITEAQFPAGVGDYLYERLRLTANHMVIS",
    "MAQTPYNIIGQDALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGPQLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MKFGEVMAQTPYNIIGQEALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGPQLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLNERLKLTANHMVNSEK",
    "MSKTPYEVIGETALYNMIAHFYSLVEKDDRINHLFPGDFAETSRKQKQFLTQFLGGLNLYTQEHGHPILKKRHMEFKITPYERDAWLENMHIAITEAQFPAGVGDYLYERLRLTANHMVIS",
    "MTQTPYEVIGAEALYDLIDNFYSLVAQDTRINHLFPTDLSETSRKQKQFLTQFLGGPNLYTQEHGHPMLKRRHLEFTITHFERDAWLENMHQAITNAQLPAGVGDYLYERLRLTANHMVNSEN",
    "MKFGEVMAQTPYNIIGQDALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGPQLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MTQTPYEVIGQDALFKMIDHFYYMVERDDRINHLFPGDFEETNRKQKQFLTQFLGGPQLYTEEHGHPMLKKRHLEFVITTDERDAWLENMYEAIQQAHFPAGVGDYLYERLRLTANHMVNSEN",
    "MKFGEVMAQTPYNIIGQEALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGLQLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MTTTPYDIIGKEALYDMIDYFYTLVEKDERLNHLFPGDFAETSRKQKQFLTQFLGGPNIYTEEHGHPMLRKRHMAFTITEFERDAWLENMQTAINRAAFPQGVGDYLFERLRLTANHMVNS",
    "MKFGEVMAQTPYNIIGQEALYAMIDHFYRLVEQDDRINYLFPGDFKETSRKQKQFLTQFLGGPQLYTEEHGHPMLKMRHMNFHISPYERDAWLENMHEAIQTADFPAGVGDYLYERLKLTANHMVNSEK",
    "MALTPYEVIGQERLYHMIDYFYSLVEQDERINHLFPGDFAETSRKQKQFLTQFLGGPALYTEEHGHPMLKMRHMDFRITTFERDAWLENMNKAIQHAELPAGVDEYLYERLRLTANHMVNSEN",
    "MTQTPYEVIGQDALFKMIDHFYYMVQRDDRINHLFPGDFEETSRKQKQFLTQFLGGPQLYTEEHGHPMLKKRHLEFVITTHERDAWLENMYKAIQQADFPAGVGDYLYERLRLTANHMVNSEN",
    "MTTTPYDIIGKEALYDMIDYFYTLVEKDERLNHLFPGDFAETSRKQKQFLIQFLGGPNIYTEEHGHPMLRKRHMDFTITEFERDAWLENMQTAINRAAFPQGVGDYLFERLRLTANHMVNS",
    "MTQTPYEIIGQDALNEMIDHFYELVKNDDRINHLFPGDFQETSRKQKQFLTQFLGGPNLYSEEHGHPMLKKRHLSFIITSFERDAWLENMYIAIQHANFPLGVGDYLYERLRLTANHMVNSEN",
    "MPKTPYDIIGQDALYQMIDHFYQLVEKDDRINHLFPGDFIETSRKQKQFLTQFLGGPDLYTQEHGHPMLKRRHMEFTITEYERDAWLENMSIAINYANFPAGVGDYLFERLRLTANHMVNSEK",
    "MTQTPYEVIGQERLYQLIDHFYSLVEQDNRINHLFPGDFAETARKQKQFLTQFLGGPDLYTQEHGHPMLRMRHLPFPIDDKAKEAWLENMHTAITHAQLPHGAGDYLYERLHLTANHMVNIEN",
    "MTTTPYDIIGKEALYDMIDYFYPLVEKDELLNHLFPGDFAETSRKQKQFLTQFLGGPNIYTEEHGHPMLRKRHIDFTITEFERDAWLENMQTAINRAAFPQGVGDYLFERLRLTANHMVNS",
    "MAQTPYEVIGQEKLYALIDHFYRLVEQDNRINHLFPGDFAETARKQKQFLTQFLGGPDLYTQEHGHPMLRMRHMSFPIDHQAKAAWLENMHIAITEARLPYGVGDYLYERLSLTANHMVNIEN",
    "MTSTPYDIIGQEALYKMIDHFYALVEQDDRINHLFPGDFQETSRKQKQFLTQFLGGPNLYTAEHGHPMLKKRHLRFKITTYERDAWLENMYIAIQAAQFPAGVGEYLYERLRLTANHMVNA",
    "MALTPYEVIGQERLYRMIDYFYSLVEQDERINHLFPGDFAETSRKQKQFLTQFLGGPALYTEEHGHPMLKMRHMDFRITTYERDAWLENMNKAIQHAELPAGVDEYLYERLRLTANHMVNSEN",
    "MTKTPYEVIGQEALDKMIDHFYLLVEQDSRINHLFPGDFAETARKQKQFLTQFLGGPNLYTEEHGHPMLRQRHLPFPIDYAAKEAWLENMAIAIETANFPHNAGAYLYERLRLTANHMVNIEN",
    "MSKTPYDIIGETALYNMIDHFYALVEKDDRINHLFPGDFAETSRKQKQFLTQFLGGPNLYTEEHGHPMLKKRHMEFKITTYERDAWLENMHTAITEAQFPAGVGEYLYERLRLTANHMVNS",
    "MPKTPYDIIGQDALYQMIDHFYDLVEKDDRINHLFPGDFIETSRKQKQFLTQFLGGPDLYTQEHGYPMLKRRHMEFTITEYERDAWLENMSIAINHANFPAGVGDYLFERLRLTANHMVNSEK",
    "MPPTPYEVIGQDALYKMIDHFYILVEQDDRINHLFPGDFNETSRKQKQFLTQFLGGPSLYTDEHGHPMLRKRHLPFKIDEAAKNAWLENMHIAIDNAQLPHGVGDYLYERLKLTASHMVNTEY",
    "MEHGDNMPRTPYDIIGQDALYQMIDHFYSLVEQDDRINHLFPGDFKETSRKQKQFLTQFLGGPDLYTQEHGHPMLKRRHMEFTITEFERDAWLENMSIAITHANFPDGVGDYLYERLRLTANHMVNSEN",
    "MTQTPYEIIGQKALYDMIDYFYYLVEQDSRINHLFPGDFAETSRKQKQFLTQFLGGPNLYTQEHGHPMLKRRHLDFIITNHERDAWLENMYKALQHADFPEGVGDYLYERLRLTANHMVNSEN",
    "MNQTPYDIIGPDALYDMIDHFYRLVEQDDRLNHLFPGDFEETSRKQKQFLTQFLGGPKLYTEEHGHPMLRKRHLAFRITNAERDAWLENMYIAIQAAQLPAGVGDYLYERLCLVANHMVNTEI",
  ];
  const data = {
    aminos: aminos,
  };

  const getTree = async () => {
    if (aminos.length <= 1) {
      console.log("2個以上のデータを指定してください");
      return;
    }
    // 木の取得
    const res = await fetch("/tree", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    });
    const treeRes = await res.json();
    const tree = treeRes.treedata;
    let nowId = 0;

    // 経過時間の描画
    elapsed.innerText = "処理時間:" + treeRes.elapsedtime + "(ms)";

    // 縦軸の調整
    const SCORE_MAX = tree[tree.length - 1].score + 0.1;

    // 木の描画
    const ONE_WIDTH = (WIDTH - PADDING) / (aminos.length - 1);
    const drawTree = (tree, id, parentScore, isLeft) => {
      const y0 = ((SCORE_MAX - parentScore) * TREE_HEIGHT) / SCORE_MAX;
      const y1 = ((SCORE_MAX - tree[id].score) * TREE_HEIGHT) / SCORE_MAX;
      console.log(y0, y1);
      // 葉の場合
      if (tree[id].left === -1 && tree[id].right === -1) {
        const x = nowId * ONE_WIDTH + PADDING / 2;
        context.fillRect(x, y0, LINE_WIDTH, y1 - y0);
        context.textAlign = "center";
        context.textBaseline = "top";
        context.fillText(id, x, TREE_HEIGHT, ONE_WIDTH);
        if (!isLeft) {
          context.textAlign = "start";
          context.textBaseline = "middle";
          context.fillText(
            (parentScore - tree[id].score).toPrecision(NUMBER_DIGIT),
            x + LINE_WIDTH + 1,
            (y1 + y0) / 2,
            ONE_WIDTH
          );
        }
        nowId++;
        return x;
      }
      // 節
      const leftx = drawTree(tree, tree[id].left, tree[id].score, true);
      const rightx = drawTree(tree, tree[id].right, tree[id].score, false);
      const x = (leftx + rightx) / 2;
      context.fillRect(x, y0, LINE_WIDTH, y1 - y0);
      context.fillRect(leftx, y1, rightx - leftx, LINE_WIDTH);
      context.textAlign = "start";
      context.textBaseline = "middle";
      context.fillText(
        (parentScore - tree[id].score).toPrecision(NUMBER_DIGIT),
        x + LINE_WIDTH + 1,
        (y1 + y0) / 2,
        ONE_WIDTH
      );
      return x;
    };
    drawTree(tree, tree.length - 1, 1, false);
  };

  getTree();
};
